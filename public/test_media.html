<?php
// public/test_media_forms.php — test senza JavaScript
if (session_status() !== PHP_SESSION_ACTIVE) { session_start(); }
require_once __DIR__ . '/../partials/csrf.php';

// prendi/crea token CSRF (adatta se la tua csrf.php usa nomi diversi)
$csrf = $_SESSION['csrf_token'] ?? null;
if (!$csrf && function_exists('csrf_generate_token')) {
  $csrf = csrf_generate_token();
} elseif (!$csrf && function_exists('csrf_token')) {
  $csrf = csrf_token();
} elseif (!$csrf) {
  $csrf = bin2hex(random_bytes(32));
  $_SESSION['csrf_token'] = $csrf;
}

$uid      = $_SESSION['uid']  ?? '';
$role     = $_SESSION['role'] ?? '';
$is_admin = (!empty($_SESSION['is_admin']) && (int)$_SESSION['is_admin'] === 1) || ($role === 'ADMIN');
?>
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Test senza JS: /api/media_save.php</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
h1{font-size:20px;margin:0 0 12px}
fieldset{margin:16px 0;padding:12px;border:1px solid #ddd;border-radius:8px}
legend{padding:0 6px;color:#333}
label{display:block;margin:6px 0 2px}
input[type=text],input[type=number]{width:100%;max-width:420px;padding:6px}
button{margin-top:8px;padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#f5f5f5;cursor:pointer}
.small{color:#666}
.badge{background:#eee;border:1px solid #ddd;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<h1>Test <code>/api/media_save.php</code> (senza JavaScript)</h1>

<p>Stato sessione: UID=<span class="badge"><?=htmlspecialchars((string)$uid)?></span>,
ROLE=<span class="badge"><?=htmlspecialchars((string)$role)?></span>,
ADMIN=<span class="badge"><?=$is_admin?'YES':'NO'?></span></p>

<ol>
  <li><b>Incognito (non loggato)</b> → usa il form A</li>
  <li><b>Loggato come utente normale</b> → usa i form B, C, D</li>
  <li><b>Loggato come admin</b> → usa il form E</li>
</ol>

<!-- A) Non loggato: 401 -->
<form action="/api/media_save.php" method="post">
  <fieldset>
    <legend>A) Non loggato → atteso 401 login_required</legend>
    <p class="small">Apri questa pagina in <b>finestra in incognito</b> e invia.</p>
    <input type="hidden" name="type" value="avatar">
    <input type="hidden" name="url" value="https://cdn.example.com/test.png">
    <input type="hidden" name="storage_key" value="test/key.png">
    <input type="hidden" name="mime" value="image/png">
    <label>owner_id (qualunque numero)</label>
    <input type="number" name="owner_id" value="999999">
    <button type="submit">Invia test A</button>
  </fieldset>
</form>

<!-- B) CSRF mancante: 419 -->
<form action="/api/media_save.php" method="post">
  <fieldset>
    <legend>B) CSRF mancante → atteso 419 invalid_csrf</legend>
    <p class="small">Usa questa pagina <b>loggato</b>. Questo form <u>non</u> include il token CSRF di proposito.</p>
    <input type="hidden" name="type" value="avatar">
    <input type="hidden" name="url" value="https://cdn.example.com/test.png">
    <input type="hidden" name="storage_key" value="test/key.png">
    <input type="hidden" name="mime" value="image/png">
    <label>owner_id = il tuo UID</label>
    <input type="number" name="owner_id" value="<?=htmlspecialchars((string)$uid)?>">
    <button type="submit">Invia test B</button>
  </fieldset>
</form>

<!-- C) Owner diverso: 403 -->
<form action="/api/media_save.php" method="post">
  <fieldset>
    <legend>C) Utente A cambia avatar di B → atteso 403 forbidden_not_owner</legend>
    <p class="small">Usa questa pagina <b>loggato come utente normale</b>.</p>
    <input type="hidden" name="type" value="avatar">
    <input type="hidden" name="url" value="https://cdn.example.com/test.png">
    <input type="hidden" name="storage_key" value="test/key.png">
    <input type="hidden" name="mime" value="image/png">
    <label>owner_id (metti un ID diverso dal tuo)</label>
    <input type="number" name="owner_id" value="<?=htmlspecialchars((string)((int)$uid + 777))?>">
    <!-- CSRF CORRETTO -->
    <input type="hidden" name="csrf_token" value="<?=htmlspecialchars($csrf)?>">
    <button type="submit">Invia test C</button>
  </fieldset>
</form>

<!-- D) Owner uguale: 200 ok -->
<form action="/api/media_save.php" method="post">
  <fieldset>
    <legend>D) Utente A cambia <u>il SUO</u> avatar → atteso 200 {"ok":true}</legend>
    <p class="small">Usa questa pagina <b>loggato come utente normale</b>.</p>
    <input type="hidden" name="type" value="avatar">
    <input type="hidden" name="url" value="https://cdn.example.com/my-avatar.png">
    <input type="hidden" name="storage_key" value="users/<?=htmlspecialchars((string)$uid)?>/avatar.png">
    <input type="hidden" name="mime" value="image/png">
    <label>owner_id = il tuo UID</label>
    <input type="number" name="owner_id" value="<?=htmlspecialchars((string)$uid)?>">
    <!-- CSRF CORRETTO -->
    <input type="hidden" name="csrf_token" value="<?=htmlspecialchars($csrf)?>">
    <button type="submit">Invia test D</button>
  </fieldset>
</form>

<!-- E) Admin: 200 ok -->
<form action="/api/media_save.php" method="post">
  <fieldset>
    <legend>E) Admin cambia avatar/logo → atteso 200 {"ok":true}</legend>
    <p class="small">Usa questa pagina <b>loggato come ADMIN</b>. Compila l'ID utente e (facoltativo) l'ID team.</p>
    <input type="hidden" name="mime" value="image/png">
    <input type="hidden" name="csrf_token" value="<?=htmlspecialchars($csrf)?>">
    <label>Operazione</label>
    <select name="type">
      <option value="avatar">Avatar utente</option>
      <option value="team_logo">Logo team</option>
    </select>
    <label>URL immagine</label>
    <input type="text" name="url" value="https://cdn.example.com/forced.png">
    <label>Storage key</label>
    <input type="text" name="storage_key" value="forced/test.png">
    <label>owner_id (per avatar)</label>
    <input type="number" name="owner_id" value="">
    <label>team_id (per logo team)</label>
    <input type="number" name="team_id" value="">
    <button type="submit">Invia test E</button>
  </fieldset>
</form>

<p class="small">Nota: la risposta dell'API apparirà come JSON nella stessa pagina (o verrà scaricata dal browser). Se vedi "login_required", "invalid_csrf", "forbidden_not_owner" o {"ok":true}, il test è passato.</p>
</body>
</html>
